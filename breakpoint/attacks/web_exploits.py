from typing import Any, Dict
from ..http_client import HttpClient
from ..scenarios import SimpleScenario

def run_prototype_pollution(client: HttpClient, scenario: SimpleScenario) -> Dict[str, Any]:
    """
    NodeJS Prototype Pollution
    Attempts to pollute Object.prototype via JSON payloads.
    Target: NodeJS / Express apps (common on port 3000).
    """
    # Payload 1: DoS / Crash via property injection that breaks logic
    # Payload 2: Property injection check
    
    payloads = [
        {"__proto__": {"polluted": "true"}},
        {"constructor": {"prototype": {"polluted": "true"}}}
    ]
    
    issues = []
    
    for p in payloads:
        # 1. Inject
        resp = client.send(scenario.method, scenario.target, json_body=p)
        
        # 2. Check if it triggered an error (500) or if the server reflected it anomalously
        if resp.status_code >= 500:
            issues.append(f"Prototype Payload caused Server Error (Potential Crash): {p}")
            
        # 3. If we could check state, we would. But stateless HTTP is hard.
        # Sometimes pollution causes all subsequent JSON responses to have "polluted": "true".
        # We can try a follow-up request?
        
    return {
        "scenario_id": scenario.id,
        "attack_type": "prototype_pollution",
        "passed": len(issues) == 0,
        "details": {"issues": issues}
    }

def run_xss_scan(client: HttpClient, scenario: SimpleScenario) -> Dict[str, Any]:
    """
    Reflected XSS Scanner
    Checks if script tags are returned unescaped.
    """
    payloads = [
        "<script>alert(1)</script>",
        "\"><script>alert(1)</script>",
        "<img src=x onerror=alert(1)>",
        "javascript:alert(1)"
    ]
    
    fields = scenario.config.get("fields", ["q", "search", "name"])
    issues = []
    
    for field in fields:
        for p in payloads:
            params = {field: p}
            resp = client.send(scenario.method, scenario.target, params=params)
            
            # Check for Literal Reflection
            if p in resp.text:
                 issues.append(f"Reflected XSS in '{field}': Payload returned unescaped")

    return {
        "scenario_id": scenario.id,
        "attack_type": "xss",
        "passed": len(issues) == 0,
        "details": {"issues": issues}
    }

def run_open_redirect(client: HttpClient, scenario: SimpleScenario) -> Dict[str, Any]:
    """
    Open Redirect Scanner
    """
    payloads = [
        "http://google.com",
        "//google.com",
        "/\\/google.com"
    ]
    fields = scenario.config.get("fields", ["next", "url", "redirect", "returnTo"])
    issues = []
    
    for field in fields:
        for p in payloads:
            params = {field: p}
            resp = client.send(scenario.method, scenario.target, params=params)
            
            # Check Headers for location
            loc = resp.headers.get("Location", "")
            if "google.com" in loc:
                issues.append(f"Open Redirect in '{field}': Location header set to external site")
                
    return {
        "scenario_id": scenario.id,
        "attack_type": "open_redirect",
        "passed": len(issues) == 0,
        "details": {"issues": issues}
    }
